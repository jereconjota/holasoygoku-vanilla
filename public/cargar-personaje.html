<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola soy Goku!</title>
    <link id="favicon" rel="shortcut icon" type="image/png" href="images/esfera.png" src="images/esfera.png">
    <!-- <link rel="stylesheet" href="/css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">



</head>
<body>
    <div class="container">
        <div class="text-center my-5">
            <h1 class="mb-5"> Agregar personaje </h1>
            <h5 id="name"></h5>
            <a target="_blank" href="" id="login">login</a>
            <a target="_blank" href="" id="logout" style="display: none;">Desconectarse</a>
        </div>
        <div>
            <form>
                <div class="form-group">
                    <label for="formGroupExampleInput">Nombre</label>
                    <input type="text" class="form-control" id="nombrePersonaje" placeholder="Goku">
                </div>
                <div class="form-group">
                    <label for="formGroupExampleInput2">Frase</label>
                    <input type="text" class="form-control" id="frasePersonaje" placeholder="Hola soy Goku">
                </div>
                <div class="form-group">
                    <label for="exampleFormControlFile1">Imagen</label>
                    <input type="file" class="form-control-file" id="imagenPersonaje">
                </div>
                <div class="text-center mt-5">
                    <a class="btn btn-dark" href="" id="btnGuardarPersonaje">Guardar</a>
                </div>
                
            </form>
        </div>
    </div>


    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-storage.js"></script>
    <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCdTcy_i1iFhR_780UjjFtxusoCHWaip8U",
        authDomain: "holasoygokufrases.firebaseapp.com",
        databaseURL: "https://holasoygokufrases.firebaseio.com",
        projectId: "holasoygokufrases",
        storageBucket: "holasoygokufrases.appspot.com",
        messagingSenderId: "720092220680",
        appId: "1:720092220680:web:b7e14a3c4d702a9df8b0bd",
        measurementId: "G-8RXEH1H8WT"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);


    let btt = document.getElementById('login')
    let off = document.getElementById('logout')
    let name = document.getElementById('name')
    let nombrePersonaje = document.getElementById('nombrePersonaje')
    let frasePersonaje = document.getElementById('frasePersonaje')
    let imagenPersonaje = document.getElementById('imagenPersonaje')
    let btnGuardarPersonaje = document.getElementById('btnGuardarPersonaje')
    let usuario = {}


    btt.addEventListener("click", (e)=>{
        e.preventDefault()
        logincongoogle()
    })
    off.addEventListener('click', (e)=>{
        e.preventDefault()
        desloguear()
    })

    function logincongoogle() {
        let provider = new firebase.auth.GoogleAuthProvider()
        firebase.auth().signInWithPopup(provider).then(result=>{
        console.log('valar morghulis', result.user.email)
        usuario = result
        console.log(usuario)
        lokearUsuario()
    }).catch(error=> console.log(error.message, error.code ))
    
    }

    function desloguear() {
        firebase.auth().signOut().then(function(){
        console.log('valar doharis')
        btt.style.display = 'block'
        off.style.display = 'none'
        deslokearUsuario()
    }).catch(function(err){
        console.log(err, "not today")
    })
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        firebase.auth().onAuthStateChanged(user=>{
            if (user) {
                usuario = {"user": user}
                lokearUsuario()
            }
            })
        })

    function lokearUsuario() {
        name.innerHTML = 'Hola '+usuario.user.displayName+"!";
        btt.style.display = 'none'
        off.style.display = 'block'
    }

    function deslokearUsuario() {
        name.innerHTML = ''
        btt.style.display = 'block'
        off.style.display = 'none'
    }

    let storageRef
    let file
    imagenPersonaje.addEventListener('change', function(e){
        file = e.target.files[0]
        storageRef = firebase.storage().ref('Personajes/'+ file.name)
    })
    
    btnGuardarPersonaje.addEventListener('click', (e)=>{
        e.preventDefault()
        storageRef.put(file)
        let urlImg 
        storageRef.getDownloadURL().then(function(url) {
            guardarPersonaje(url)
        }).catch(error=> console.log(error))
        })
    

        function guardarPersonaje(urlImagen) {
            const personaje = {
            nombre: nombrePersonaje.value,
            frase: frasePersonaje.value,
            urlImagen: urlImagen
        }
        const db = firebase.database()
        console.log(db)
        const dbRef = db.ref('Personajes')
        const nuevoPersonaje = dbRef.push()
        nuevoPersonaje.set(personaje)

        nombrePersonaje.value = ''
        frasePersonaje.value = ''
        imagenPersonaje.value = ''
        console.log('se guardo el personaje')
        }
        
    </script>
</body>
</html>